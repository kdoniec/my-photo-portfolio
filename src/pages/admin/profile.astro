---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { ProfilePage } from "@/components/admin/profile/ProfilePage";
import type { ProfileDTO, SettingsDTO, StatsDTO } from "@/types";
import { ProfileService } from "@/lib/services/profile.service";
import { SettingsService } from "@/lib/services/settings.service";
import { StatsService } from "@/lib/services/stats.service";

// Defense in depth: Page-level auth guard (middleware provides primary protection)
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/admin/login");
}

const supabase = Astro.locals.supabase;

// Fetch profile directly from service (avoid self-fetch on Cloudflare)
let profile: ProfileDTO | null = null;
let profileError: string | null = null;

try {
  const profileService = new ProfileService(supabase);
  profile = await profileService.getProfile(user.id);
} catch (err) {
  profileError = err instanceof Error ? err.message : "Nieznany błąd";
  console.error("Błąd podczas pobierania profilu:", err);
}

// Fetch settings directly from service (avoid self-fetch on Cloudflare)
let settings: SettingsDTO | null = null;
let settingsError: string | null = null;

try {
  const settingsService = new SettingsService(supabase);
  settings = await settingsService.getSettings(user.id);
} catch (err) {
  settingsError = err instanceof Error ? err.message : "Nieznany błąd";
  console.error("Błąd podczas pobierania ustawień:", err);
}

// Fetch stats directly from service (avoid self-fetch on Cloudflare)
let stats: StatsDTO | null = null;
let statsError: string | null = null;

try {
  const statsService = new StatsService(supabase);
  stats = await statsService.getStats(user.id);
} catch (err) {
  statsError = err instanceof Error ? err.message : "Nieznany błąd";
  console.error("Błąd podczas pobierania statystyk:", err);
}
---

<AdminLayout title="Profil - Panel Administracyjny" activeNav="profile">
  <div class="space-y-6">
    <div>
      <h1 class="text-3xl font-bold">Profil</h1>
      <p class="text-muted-foreground">Zarządzaj swoim profilem i ustawieniami strony</p>
    </div>

    {
      profileError && (
        <div class="rounded-lg border border-destructive bg-destructive/10 p-4 text-destructive">
          <p class="font-medium">Błąd podczas ładowania profilu</p>
          <p class="text-sm">{profileError}</p>
        </div>
      )
    }

    {
      settingsError && (
        <div class="rounded-lg border border-destructive bg-destructive/10 p-4 text-destructive">
          <p class="font-medium">Błąd podczas ładowania ustawień</p>
          <p class="text-sm">{settingsError}</p>
        </div>
      )
    }

    {
      statsError && (
        <div class="rounded-lg border border-destructive bg-destructive/10 p-4 text-destructive">
          <p class="font-medium">Błąd podczas ładowania statystyk</p>
          <p class="text-sm">{statsError}</p>
        </div>
      )
    }

    {
      !profileError && !settingsError && !statsError && profile && settings && stats && (
        <ProfilePage profile={profile} settings={settings} stats={stats} client:load />
      )
    }
  </div>
</AdminLayout>
