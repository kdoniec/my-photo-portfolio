---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { CategoriesPage } from "@/components/admin/categories/CategoriesPage";
import type { CategoryListResponseDTO, StatsDTO } from "@/types";
import { CategoryService } from "@/lib/services/category.service";
import { StatsService } from "@/lib/services/stats.service";

// Defense in depth: Page-level auth guard (middleware provides primary protection)
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/admin/login");
}

const supabase = Astro.locals.supabase;

// Fetch categories directly from service (avoid self-fetch on Cloudflare)
let categories: CategoryListResponseDTO["data"] = [];
let categoriesError: string | null = null;

try {
  const categoryService = new CategoryService(supabase);
  const data = await categoryService.getCategories(user.id);
  categories = data.data;
} catch (err) {
  categoriesError = err instanceof Error ? err.message : "Nieznany błąd";
  console.error("Błąd podczas pobierania kategorii:", err);
}

// Fetch stats directly from service (avoid self-fetch on Cloudflare)
let stats: StatsDTO | null = null;
let statsError: string | null = null;

try {
  const statsService = new StatsService(supabase);
  stats = await statsService.getStats(user.id);
} catch (err) {
  statsError = err instanceof Error ? err.message : "Nieznany błąd";
  console.error("Błąd podczas pobierania statystyk:", err);
}
---

<AdminLayout title="Kategorie - Panel Administracyjny" activeNav="categories">
  <div class="space-y-6">
    <div>
      <h1 class="text-3xl font-bold">Kategorie</h1>
      <p class="text-muted-foreground">Zarządzaj kategoriami zdjęć w swoim portfolio</p>
    </div>

    {
      categoriesError && (
        <div class="rounded-lg border border-destructive bg-destructive/10 p-4 text-destructive">
          <p class="font-medium">Błąd podczas ładowania kategorii</p>
          <p class="text-sm">{categoriesError}</p>
        </div>
      )
    }

    {
      statsError && (
        <div class="rounded-lg border border-destructive bg-destructive/10 p-4 text-destructive">
          <p class="font-medium">Błąd podczas ładowania statystyk</p>
          <p class="text-sm">{statsError}</p>
        </div>
      )
    }

    {
      !categoriesError && !statsError && stats && (
        <CategoriesPage initialCategories={categories} stats={stats} client:load />
      )
    }
  </div>
</AdminLayout>
